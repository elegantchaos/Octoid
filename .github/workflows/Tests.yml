# --------------------------------------------------------------------------------
# This workflow was automatically generated by ActionBuilderTool 2.1.6 (112).
# (see https://github.com/elegantchaos/ActionBuilderCore for more details)
# --------------------------------------------------------------------------------

name: Tests

on: [push, pull_request]

jobs:

    macOS-swift62:
        name: macOS (Swift 6.2)
        runs-on: macos-15
        steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Install xcbeautify
          run: |
            if command -v xcbeautify >/dev/null 2>&1
            then
              echo "xcbeautify already installed."
            elif brew install xcbeautify > logs/install-xcbeautify.log 2>&1
            then
              echo "xcbeautify installed."
            else
              echo "::error::Failed to install xcbeautify."
              cat logs/install-xcbeautify.log
              exit 1
            fi
        - name: Make Logs Directory
          run: mkdir logs
        - name: Select Swift
          uses: swift-actions/setup-swift@v2
          with:
            swift-version: "6.2"
        - name: Swift Version
          run: swift --version
        - name: Build (release)
          run: |
            LOG="logs/swift-build-release.log"
            if swift build --configuration release --quiet >"$LOG" 2>&1
            then
              echo "Build (release) succeeded."
            else
              echo "::error::Build (release) failed."
              cat "$LOG" | xcbeautify --quiet --disable-logging --renderer github-actions || cat "$LOG"
              echo "Build (release) failed."
              exit 1
            fi
        - name: Test (release XCTest)
          run: |
            LOG="logs/swift-test-xctest-release.log"
            if swift test --disable-swift-testing --configuration release >"$LOG" 2>&1
            then
              echo "Test (release XCTest) succeeded."
            else
              echo "::error::Test (release XCTest) failed."
              cat "$LOG" | xcbeautify --quiet --disable-logging --renderer github-actions || cat "$LOG"
              echo "Test (release XCTest) failed."
              exit 1
            fi
        - name: Test (release Swift Testing)
          run: |
            LOG="logs/swift-test-swift-testing-release.log"
            if swift test --disable-xctest --configuration release >"$LOG" 2>&1
            then
              echo "Test (release Swift Testing) succeeded."
            else
              echo "::error::Test (release Swift Testing) failed."
              cat "$LOG" | xcbeautify --quiet --disable-logging --renderer github-actions || cat "$LOG"
              echo "Test (release Swift Testing) failed."
              exit 1
            fi
        - name: Upload Logs
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: macOS-swift62-logs
            path: logs


    xcode-swift62:
        name: iOS/tvOS/watchOS (Swift 6.2, Xcode matching Swift 6.2)
        runs-on: macos-15
        steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Install xcbeautify
          run: |
            if command -v xcbeautify >/dev/null 2>&1
            then
              echo "xcbeautify already installed."
            elif brew install xcbeautify > logs/install-xcbeautify.log 2>&1
            then
              echo "xcbeautify installed."
            else
              echo "::error::Failed to install xcbeautify."
              cat logs/install-xcbeautify.log
              exit 1
            fi
        - name: Make Logs Directory
          run: mkdir logs
        - name: Resolve Xcode Version
          id: resolve-xcode
          run: |
            REQUESTED_SWIFT="6.2"
            ls -d /Applications/Xcode* > logs/xcode-versions.log
            FOUND_XCODE=""
            while read -r APP
            do
              DEV_DIR="$APP/Contents/Developer"
              SWIFT_VERSION=$(DEVELOPER_DIR="$DEV_DIR" xcrun swift --version 2>/dev/null | head -n 1 | sed -E 's/.*version ([0-9]+\.[0-9]+).*/\1/')
              XCODE_VERSION=$(DEVELOPER_DIR="$DEV_DIR" xcodebuild -version 2>/dev/null | awk '/^Xcode / {print $2; exit}')
              if [[ "$SWIFT_VERSION" == "$REQUESTED_SWIFT" ]]
              then
                FOUND_XCODE="$XCODE_VERSION"
                break
              fi
            done < <(ls -d /Applications/Xcode*.app | sort -Vr)

            if [[ "$FOUND_XCODE" == "" ]]
            then
              echo "No installed Xcode matched Swift $REQUESTED_SWIFT."
              echo "Detected toolchains:"
              while read -r APP
              do
                DEV_DIR="$APP/Contents/Developer"
                XCODE_VERSION=$(DEVELOPER_DIR="$DEV_DIR" xcodebuild -version 2>/dev/null | awk '/^Xcode / {print $2; exit}')
                SWIFT_VERSION=$(DEVELOPER_DIR="$DEV_DIR" xcrun swift --version 2>/dev/null | head -n 1 | sed -E 's/.*version ([0-9]+\.[0-9]+).*/\1/')
                echo "  Xcode $XCODE_VERSION -> Swift $SWIFT_VERSION"
              done < <(ls -d /Applications/Xcode*.app | sort -Vr)
              exit 1
            fi

            echo "version=$FOUND_XCODE" >> "$GITHUB_OUTPUT"
        - name: Select Xcode Version
          uses: maxim-lobanov/setup-xcode@v1
          with:
            xcode-version: ${{ steps.resolve-xcode.outputs.version }}
        - name: Xcode Version
          run: |
            xcodebuild -version
            swift --version
        - name: Detect Workspace & Scheme (iOS)
          run: |
            WORKSPACE="Octoid.xcworkspace"
            if [[ ! -e "$WORKSPACE" ]]
            then
              WORKSPACE="."
              GOTPACKAGE=$(xcodebuild -workspace . -list | (grep Octoid-Package || true))
              if [[ $GOTPACKAGE != "" ]]
              then
                SCHEME="Octoid-Package"
              else
                SCHEME="Octoid"
              fi
            else
              SCHEME="Octoid-iOS"
            fi
            echo "export PATH='swift-latest:$PATH'; WORKSPACE='$WORKSPACE'; SCHEME='$SCHEME'" > setup.sh
        - name: Test (iOS Release)
          run: |
            set -o pipefail
            source "setup.sh"
            xcodebuild -downloadPlatform iOS > logs/download-iOS.log
            xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -showdestinations > logs/destinations-iOS.log
            DESTINATION=$(cat logs/destinations-iOS.log | grep "platform:iOS Simulator" | grep "name:iPhone" | head -n 1 | awk -F" }" '{print$1}' | awk -F"name:" '{print$2}')
            echo "Testing workspace $WORKSPACE scheme $SCHEME on $DESTINATION."
            xcodebuild test -workspace "$WORKSPACE" -scheme "$SCHEME" -destination "name=$DESTINATION" -configuration Release CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO ENABLE_TESTABILITY=YES | tee logs/xcodebuild-iOS-test-release.log | xcbeautify --quiet --disable-logging --renderer github-actions
        - name: Detect Workspace & Scheme (tvOS)
          run: |
            WORKSPACE="Octoid.xcworkspace"
            if [[ ! -e "$WORKSPACE" ]]
            then
              WORKSPACE="."
              GOTPACKAGE=$(xcodebuild -workspace . -list | (grep Octoid-Package || true))
              if [[ $GOTPACKAGE != "" ]]
              then
                SCHEME="Octoid-Package"
              else
                SCHEME="Octoid"
              fi
            else
              SCHEME="Octoid-tvOS"
            fi
            echo "export PATH='swift-latest:$PATH'; WORKSPACE='$WORKSPACE'; SCHEME='$SCHEME'" > setup.sh
        - name: Test (tvOS Release)
          run: |
            set -o pipefail
            source "setup.sh"
            xcodebuild -downloadPlatform tvOS > logs/download-tvOS.log
            xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -showdestinations > logs/destinations-tvOS.log
            DESTINATION=$(cat logs/destinations-tvOS.log | grep "platform:tvOS Simulator" | grep "name:Apple TV" | head -n 1 | awk -F" }" '{print$1}' | awk -F"name:" '{print$2}')
            echo "Testing workspace $WORKSPACE scheme $SCHEME on $DESTINATION."
            xcodebuild test -workspace "$WORKSPACE" -scheme "$SCHEME" -destination "name=$DESTINATION" -configuration Release CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO ENABLE_TESTABILITY=YES | tee logs/xcodebuild-tvOS-test-release.log | xcbeautify --quiet --disable-logging --renderer github-actions
        - name: Detect Workspace & Scheme (watchOS)
          run: |
            WORKSPACE="Octoid.xcworkspace"
            if [[ ! -e "$WORKSPACE" ]]
            then
              WORKSPACE="."
              GOTPACKAGE=$(xcodebuild -workspace . -list | (grep Octoid-Package || true))
              if [[ $GOTPACKAGE != "" ]]
              then
                SCHEME="Octoid-Package"
              else
                SCHEME="Octoid"
              fi
            else
              SCHEME="Octoid-watchOS"
            fi
            echo "export PATH='swift-latest:$PATH'; WORKSPACE='$WORKSPACE'; SCHEME='$SCHEME'" > setup.sh
        - name: Build (watchOS release)
          run: |
            set -o pipefail
            source "setup.sh"
            xcodebuild -downloadPlatform watchOS > logs/download-watchOS.log
            xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -showdestinations > logs/destinations-watchOS.log
            DESTINATION=$(cat logs/destinations-watchOS.log | grep "platform:watchOS Simulator" | grep "name:Apple Watch" | head -n 1 | awk -F" }" '{print$1}' | awk -F"name:" '{print$2}')
            echo "Building workspace $WORKSPACE scheme $SCHEME."
            xcodebuild clean build -workspace "$WORKSPACE" -scheme "$SCHEME" -destination "name=$DESTINATION" -configuration Release CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO ENABLE_TESTABILITY=YES | tee logs/xcodebuild-watchOS-build-release.log | xcbeautify --quiet --disable-logging --renderer github-actions
        - name: Upload Logs
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: xcode-swift62-logs
            path: logs

